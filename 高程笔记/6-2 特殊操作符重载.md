
## C++特殊操作符
- 赋值操作符"="
- 动态对象创建与撤销操作符new与delete
- 访问数组元素操作符"[]"
- 函数调用操作符"()"
- 类成员访问操作符"->"
- 类型转换操作符

## 赋值操作符"="的重载

### 隐式赋值操作
- C++为每个类定义隐式赋值操作
- 行为：逐个成员进行赋值
  - 普通成员：常规赋值
  - 成员对象：调用该成员对象类的赋值操作

### 需要自定义赋值操作符的情况
```cpp
class String {
    int len;
    char *str;
public:
    String(const char *s) {
        len = strlen(s);
        str = new char[len+1];
        strcpy(str,s);
    }
    ~String() { delete []str; str=NULL; }
};
```
问题：
1. 内存泄露
2. 对象互相干扰
3. 空间被释放两次

### 解决方案
```cpp
String& operator=(const String& s) {
    if (&s == this) return *this;  //防止自身赋值
    delete []str;
    str = new char[s.len+1];
    strcpy(str,s.str);
    len = s.len; 
    return *this;
}
```

### 成员对象的赋值
```cpp
class B {
    A a;
    int x,y;
public:
    B& operator=(const B& b) {
        if (&b == this) return *this; 
        a = b.a;  //显式调用A类的赋值操作
        x = b.x;
        y = b.y;
        return *this;
    }
};
```

### 初始化与赋值的区别
```cpp
A a;
A b = a;  //初始化，调用拷贝构造函数
b = a;    //赋值，调用赋值操作符重载函数
```

## 操作符new与delete的重载

### 基本功能
- new:
  - 分配空间
  - 调用构造函数
- delete:
  - 调用析构函数
  - 释放空间

### 重载格式
```cpp
void *operator new(size_t size);
void operator delete(void *p);
```

### 示例：初始化全'0'
```cpp
void *operator new(size_t size) {
    void *p = malloc(size);
    memset(p,0,size);
    return p;
}
```

### 带额外参数的new
```cpp
void *operator new(size_t size, void *p) {
    return p;
}
// 使用
char buf[sizeof(A)];
A *p = new (buf) A(1,2);
p->~A();
```

### 自定义堆空间管理
```cpp
class A {
    static A *p_free;
    A *next;
public:
    static void *operator new(size_t size);
    static void operator delete(void *p);
};
```

## 访问数组元素操作符"[]"的重载

### 示例：String类
```cpp
char &operator[](int i) { return str[i]; }
char operator[](int i) const { return str[i]; }
```

### 示例：Matrix类
```cpp
Vector& operator[](int i) { return ?; }
// 使用
Matrix m(10,20);
m[2][3];  //访问第三行第四列元素
```

## 函数调用操作符"()"的重载

### 函数对象示例
```cpp
class A {
    int value;
public:
    A(int i) { value = i; }
    int operator()(int x) { return x+value; }
};
// 使用
A a(3);
cout << a(10);  //输出13
```

### 随机数生成器
```cpp
class RandomNum {
    unsigned int seed;
public:
    RandomNum(unsigned int i) { seed = i; }
    unsigned int operator()() {
        seed = (25173*seed+13849)%65536;
        return seed;
    }
};
```

### λ表达式实现
- 隐式定义类
- 重载函数调用操作符
- 创建临时对象

## 类成员访问操作符"->"的重载

### 指针类示例
```cpp
class PtrA {
    A *p_a;
    int count;
public:
    PtrA(A *p) { p_a = p; count = 0; }
    A *operator->() { count++; return p_a; }
    int num_of_a_access() const { return count; }
};
```

### 完全模拟指针
```cpp
A& operator*() { return *p_a; }
A& operator[](int i) { return p_a[i]; }
```

## 类型转换操作符

### 构造函数作为转换
```cpp
Complex(double r) { real = r; imag = 0; }
// 使用
Complex c(1,2);
c + 1.7;  //1.7隐式转换为Complex(1.7)
```

### 自定义类型转换
```cpp
operator int() { return x+y; }
// 使用
A a;
int i = 1;
i + a;  //a隐式转换为int
```

### 歧义问题
```cpp
// 解决方案1：显式转换
(int)a + i
a + (A)i

// 解决方案2：explicit
explicit A(int i) { x = i; y = 0; }
explicit operator int() { return x+y; }
```